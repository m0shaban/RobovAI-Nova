<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ - RobovAI Nova</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0a0a1a;
        --surface: #111122;
        --primary: #00f0ff;
        --secondary: #8b5cf6;
        --text: #e0e0e0;
        --text-muted: #6b7280;
        --border: rgba(255, 255, 255, 0.1);
        --success: #22c55e;
        --telegram: #229ed9;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: 'Cairo', sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-image: radial-gradient(
          circle at 10% 20%,
          #1a1a2e 0%,
          #0a0a1a 100%
        );
        padding: 20px;
        overflow-y: auto;
      }

      /* Animated Background */
      .bg-effects {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        overflow: hidden;
        pointer-events: none;
      }
      .bg-orb {
        position: absolute;
        border-radius: 50%;
        filter: blur(120px);
        opacity: 0.25;
        animation: orbFloat 20s infinite ease-in-out;
      }
      .bg-orb:nth-child(1) {
        width: 500px;
        height: 500px;
        background: linear-gradient(135deg, var(--primary), transparent);
        top: -180px;
        right: -180px;
      }
      .bg-orb:nth-child(2) {
        width: 400px;
        height: 400px;
        background: linear-gradient(135deg, var(--secondary), transparent);
        bottom: -180px;
        left: -180px;
        animation-delay: -10s;
      }
      @keyframes orbFloat {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
        }
        50% {
          transform: translate(30px, 30px) scale(1.1);
        }
      }

      .copyright {
        margin-top: 1.5rem;
        font-size: 0.75rem;
        color: var(--text-muted);
        opacity: 0.6;
        position: relative;
        z-index: 1;
      }

      .auth-card {
        background: var(--surface);
        padding: 2.5rem;
        border-radius: 24px;
        width: 100%;
        max-width: 440px;
        border: 1px solid var(--border);
        box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        text-align: center;
        position: relative;
        overflow: hidden;
        z-index: 1;
        animation: cardEntrance 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
      }
      @keyframes cardEntrance {
        from {
          opacity: 0;
          transform: translateY(30px) scale(0.96);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      .logo {
        margin-bottom: 1rem;
      }
      .logo img {
        width: 80px;
        height: auto;
        filter: drop-shadow(0 0 20px rgba(0, 240, 255, 0.35));
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
      }
      .subtitle {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 1.5rem;
      }

      /* Steps indicator */
      .steps {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-bottom: 1.5rem;
      }
      .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--border);
        transition: all 0.4s;
      }
      .step-dot.active {
        background: var(--secondary);
        box-shadow: 0 0 10px var(--secondary);
        width: 28px;
        border-radius: 5px;
      }
      .step-dot.done {
        background: var(--success);
      }

      /* Form */
      .input-group {
        margin-bottom: 1.1rem;
        text-align: right;
      }
      label {
        display: block;
        margin-bottom: 0.4rem;
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      input {
        width: 100%;
        padding: 0.8rem 1rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: white;
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.3s;
      }
      input:focus {
        outline: none;
        border-color: var(--secondary);
        box-shadow: 0 0 15px rgba(139, 92, 246, 0.15);
      }

      /* Buttons */
      .btn {
        width: 100%;
        padding: 0.85rem;
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.95rem;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      .btn:hover {
        transform: scale(1.02);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--secondary), var(--primary));
        margin-top: 0.5rem;
      }
      .btn-primary:hover {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.3);
      }
      .btn-telegram {
        background: var(--telegram);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 1rem;
        font-size: 1rem;
        text-decoration: none;
      }
      .btn-telegram:hover {
        box-shadow: 0 0 20px rgba(34, 158, 217, 0.4);
      }
      .btn-telegram svg {
        width: 22px;
        height: 22px;
        fill: white;
      }

      .footer-text {
        margin-top: 1.5rem;
        font-size: 0.85rem;
        color: var(--text-muted);
      }
      .footer-text a {
        color: var(--secondary);
        text-decoration: none;
      }

      .error-msg {
        color: #ef4444;
        margin-top: 0.75rem;
        font-size: 0.85rem;
        display: none;
        background: rgba(239, 68, 68, 0.08);
        padding: 8px 12px;
        border-radius: 8px;
      }

      /* Password toggle */
      .pw-wrap {
        position: relative;
      }
      .toggle-pw {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 1.1rem;
        padding: 4px;
      }

      /* Step panels */
      .step-panel {
        display: none;
        animation: fadeIn 0.45s;
      }
      .step-panel.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* OTP */
      .otp-wrap {
        display: flex;
        gap: 8px;
        direction: ltr;
        justify-content: center;
        margin: 1.25rem 0;
      }
      .otp-wrap input {
        width: 48px;
        height: 56px;
        text-align: center;
        font-size: 1.6rem;
        font-weight: 700;
        border-radius: 14px;
        padding: 0;
        caret-color: var(--primary);
        background: rgba(255, 255, 255, 0.04);
      }
      .otp-wrap input:focus {
        border-color: var(--primary);
        background: rgba(0, 240, 255, 0.05);
      }

      /* Telegram guide */
      .telegram-guide {
        background: rgba(34, 158, 217, 0.08);
        border: 1px solid rgba(34, 158, 217, 0.2);
        border-radius: 14px;
        padding: 1.25rem;
        margin: 1rem 0;
        text-align: right;
      }
      .telegram-guide h3 {
        color: var(--telegram);
        font-size: 0.95rem;
        margin-bottom: 0.75rem;
      }
      .telegram-guide ol {
        padding-right: 1.25rem;
        font-size: 0.85rem;
        color: var(--text-muted);
        line-height: 2;
      }
      .telegram-guide li {
        margin-bottom: 2px;
      }
      .telegram-guide code {
        background: rgba(255, 255, 255, 0.08);
        padding: 2px 8px;
        border-radius: 6px;
        font-family: monospace;
        color: var(--primary);
        font-size: 0.82rem;
      }

      .telegram-email-hint {
        background: rgba(139, 92, 246, 0.12);
        border: 1px solid rgba(139, 92, 246, 0.28);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 0.82rem;
        color: var(--text);
        margin: 0.75rem 0;
      }
      .telegram-actions {
        display: flex;
        gap: 10px;
        margin-top: 0.75rem;
      }
      .btn-ghost {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid var(--border);
      }
      .btn-ghost:hover {
        box-shadow: 0 0 16px rgba(255, 255, 255, 0.08);
      }

      .timer {
        color: var(--text-muted);
        font-size: 0.82rem;
        margin-top: 6px;
      }
      .timer span {
        color: var(--primary);
        font-weight: 600;
      }
      .resend-link {
        color: var(--secondary);
        cursor: pointer;
        font-size: 0.85rem;
        margin-top: 8px;
        text-decoration: underline;
        display: inline-block;
      }
      .resend-link:hover {
        color: var(--primary);
      }

      .success-box {
        background: rgba(34, 197, 94, 0.08);
        border: 1px solid rgba(34, 197, 94, 0.2);
        border-radius: 14px;
        padding: 2rem;
        text-align: center;
      }
      .success-box .icon {
        font-size: 3rem;
        margin-bottom: 0.5rem;
      }
      .success-box h2 {
        color: var(--success);
        margin-bottom: 0.5rem;
      }
      .verify-otp-panel {
        margin-top: 1.5rem;
        text-align: center;
      }
      .otp-label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-muted);
        font-size: 0.85rem;
      }
      .is-hidden {
        display: none;
      }
      .success-subtitle {
        color: var(--text-muted);
        margin-bottom: 1.5rem;
      }
    </style>
  </head>
  <body>
    <div class="bg-effects">
      <div class="bg-orb"></div>
      <div class="bg-orb"></div>
    </div>
    <div class="auth-card">
      <div class="logo">
        <img
          src="public/assets/logo.png"
          alt="RobovAI Nova Logo"
          style="
            width: 100px;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.5));
          "
        />
      </div>

      <!-- Steps Indicator -->
      <div class="steps">
        <div class="step-dot active" id="dot1"></div>
        <div class="step-dot" id="dot2"></div>
        <div class="step-dot" id="dot3"></div>
      </div>

      <!-- â•â•â• STEP 1: Registration Form â•â•â• -->
      <div class="step-panel active" id="step1">
        <h1>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
        <p class="subtitle">Ø§Ø¨Ø¯Ø£ Ø±Ø­Ù„ØªÙƒ Ù…Ø¹ RobovAI Nova</p>

        <form id="signupForm">
          <div class="input-group">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input
              type="text"
              id="fullname"
              required
              placeholder="Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯"
              autocomplete="name"
            />
          </div>
          <div class="input-group">
            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input
              type="email"
              id="email"
              required
              placeholder="name@example.com"
              autocomplete="email"
            />
          </div>
          <div class="input-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="pw-wrap">
              <input
                type="password"
                id="password"
                required
                placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                minlength="8"
                autocomplete="new-password"
              />
              <button
                type="button"
                class="toggle-pw"
                onclick="togglePw()"
                aria-label="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              >
                ğŸ‘ï¸
              </button>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="registerBtn">
            Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
          </button>
          <div class="error-msg" id="step1Error"></div>
        </form>
        <div class="footer-text">
          Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a href="/login">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</a>
        </div>
      </div>

      <!-- â•â•â• STEP 2: Telegram Verification â•â•â• -->
      <div class="step-panel" id="step2">
        <h1>ğŸ” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨</h1>
        <p class="subtitle">ÙØ¹Ù‘Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø©</p>

        <div class="telegram-guide">
          <h3>ğŸ“± Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„</h3>
          <ol>
            <li>Ø§ÙØªØ­ Ø¨ÙˆØª <b>RobovAI</b> ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù…</li>
            <li>Ø³ÙŠØ¨Ø¯Ø£ <code>/verify</code> ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„</li>
            <li>Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨</li>
            <li>Ø³ÙŠØ¸Ù‡Ø± Ù„Ùƒ <b>ÙƒÙˆØ¯ ØªØ­Ù‚Ù‚</b> Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…</li>
            <li>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø£Ø³ÙÙ„ â¬‡ï¸</li>
          </ol>
        </div>

        <div class="telegram-email-hint" id="telegramEmailHint">
          Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….
        </div>

        <div class="telegram-actions">
          <button
            type="button"
            class="btn btn-ghost"
            id="copyEmailBtn"
            onclick="copyRegisteredEmail()"
          >
            ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯
          </button>
        </div>

        <a
          href="https://t.me/robovainova_bot"
          target="_blank"
          rel="noopener noreferrer"
          class="btn btn-telegram"
          id="openTelegramBtn"
        >
          <svg viewBox="0 0 24 24">
            <path
              d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"
            />
          </svg>
          Ø§ÙØªØ­ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¢Ù†
        </a>

        <div class="verify-otp-panel">
          <label class="otp-label">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</label>
          <div class="otp-wrap" id="otpWrap">
            <input
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="otp-digit"
              data-idx="0"
            />
            <input
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="otp-digit"
              data-idx="1"
            />
            <input
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="otp-digit"
              data-idx="2"
            />
            <input
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="otp-digit"
              data-idx="3"
            />
            <input
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="otp-digit"
              data-idx="4"
            />
            <input
              type="text"
              maxlength="1"
              inputmode="numeric"
              pattern="[0-9]"
              class="otp-digit"
              data-idx="5"
            />
          </div>
          <div class="timer" id="otpTimer">
            ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯: <span id="countdown">10:00</span>
          </div>
          <div
            class="resend-link is-hidden"
            id="resendLink"
            onclick="resendOTP()"
          >
            Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯
          </div>
        </div>

        <button
          class="btn btn-primary"
          id="verifyBtn"
          disabled
          onclick="verifyOTP()"
        >
          ØªØ­Ù‚Ù‚ ÙˆÙØ¹Ù‘Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨
        </button>
        <div class="error-msg" id="step2Error"></div>
      </div>

      <!-- â•â•â• STEP 3: Success â•â•â• -->
      <div class="step-panel" id="step3">
        <div class="success-box">
          <div class="icon">ğŸ‰</div>
          <h2>ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ!</h2>
          <p class="success-subtitle">
            Ø­Ø³Ø§Ø¨Ùƒ Ø¬Ø§Ù‡Ø². Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ RobovAI Nova ğŸš€
          </p>
          <button class="btn btn-primary" onclick="goToChat()">
            Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
          </button>
        </div>
      </div>
    </div>
    <small class="copyright">&copy; 2026 RobovAI Solutions</small>

    <script>
      const API_BASE =
        window.location.hostname === '' || window.location.protocol === 'file:'
          ? 'http://localhost:8000'
          : window.location.origin;

      let registeredEmail = '';
      let countdownInterval = null;

      function base64UrlEncode(value) {
        const utf8Bytes = new TextEncoder().encode(value);
        let binary = '';
        utf8Bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary)
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      }

      function buildTelegramVerifyLink(email) {
        const base = 'https://t.me/robovainova_bot';
        const normalized = (email || '').trim().toLowerCase();
        if (!normalized) {
          return `${base}?start=verify`;
        }
        const encodedEmail = base64UrlEncode(normalized);
        return `${base}?start=verify_${encodedEmail}`;
      }

      function updateTelegramActivationUI() {
        const hint = document.getElementById('telegramEmailHint');
        const telegramBtn = document.getElementById('openTelegramBtn');
        const email = (registeredEmail || '').trim().toLowerCase();

        telegramBtn.href = buildTelegramVerifyLink(email);

        hint.innerHTML = email
          ? `Ø³ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¨Ø±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª: <b>${email}</b>`
          : 'Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….';
      }

      async function copyRegisteredEmail() {
        const email = (registeredEmail || '').trim();
        if (!email) {
          return;
        }

        try {
          await navigator.clipboard.writeText(email);
          const btn = document.getElementById('copyEmailBtn');
          const prev = btn.textContent;
          btn.textContent = 'âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¨Ø±ÙŠØ¯';
          setTimeout(() => {
            btn.textContent = prev;
          }, 1200);
        } catch (error) {
          console.error('Copy failed', error);
        }
      }

      function togglePw() {
        const i = document.getElementById('password');
        i.type = i.type === 'password' ? 'text' : 'password';
      }

      /* â”€â”€ Step Navigation â”€â”€ */
      function goToStep(n) {
        document
          .querySelectorAll('.step-panel')
          .forEach((p) => p.classList.remove('active'));
        document.getElementById('step' + n).classList.add('active');
        for (let i = 1; i <= 3; i++) {
          const dot = document.getElementById('dot' + i);
          dot.classList.remove('active', 'done');
          if (i < n) dot.classList.add('done');
          else if (i === n) dot.classList.add('active');
        }
      }

      /* â”€â”€ STEP 1: Register â”€â”€ */
      document
        .getElementById('signupForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = document.getElementById('registerBtn');
          const err = document.getElementById('step1Error');
          err.style.display = 'none';
          btn.disabled = true;
          btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';

          const fullname = document.getElementById('fullname').value.trim();
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;

          try {
            const res = await fetch(`${API_BASE}/auth/register`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password, full_name: fullname }),
            });
            const ct = res.headers.get('content-type') || '';
            let data = ct.includes('json')
              ? await res.json()
              : { detail: await res.text() };

            if (
              res.ok &&
              (data.status === 'pending_verification' ||
                data.status === 'success')
            ) {
              registeredEmail = email;
              updateTelegramActivationUI();
              goToStep(2);
              startCountdown(600);
            } else {
              err.textContent =
                data.detail || data.message || 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨';
              err.style.display = 'block';
            }
          } catch (ex) {
            err.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
            err.style.display = 'block';
          }
          btn.disabled = false;
          btn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
        });

      /* â”€â”€ OTP Inputs â”€â”€ */
      const otpInputs = document.querySelectorAll('.otp-digit');
      otpInputs.forEach((inp, i) => {
        inp.addEventListener('input', (e) => {
          const val = e.target.value.replace(/\D/g, '');
          e.target.value = val;
          if (val && i < 5) otpInputs[i + 1].focus();
          checkOTPComplete();
        });
        inp.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !inp.value && i > 0)
            otpInputs[i - 1].focus();
        });
        inp.addEventListener('paste', (e) => {
          e.preventDefault();
          const pasted = (e.clipboardData.getData('text') || '')
            .replace(/\D/g, '')
            .slice(0, 6);
          pasted.split('').forEach((ch, idx) => {
            if (otpInputs[idx]) otpInputs[idx].value = ch;
          });
          if (pasted.length > 0) otpInputs[Math.min(pasted.length, 5)].focus();
          checkOTPComplete();
        });
      });

      function getOTPValue() {
        return Array.from(otpInputs)
          .map((i) => i.value)
          .join('');
      }
      function checkOTPComplete() {
        document.getElementById('verifyBtn').disabled =
          getOTPValue().length !== 6;
      }

      /* â”€â”€ Countdown â”€â”€ */
      function startCountdown(seconds) {
        clearInterval(countdownInterval);
        const el = document.getElementById('countdown');
        const resend = document.getElementById('resendLink');
        const timerDiv = document.getElementById('otpTimer');
        resend.classList.add('is-hidden');
        timerDiv.classList.remove('is-hidden');
        let remaining = seconds;
        const tick = () => {
          const m = Math.floor(remaining / 60);
          const s = remaining % 60;
          el.textContent = `${m}:${s.toString().padStart(2, '0')}`;
          if (remaining <= 0) {
            clearInterval(countdownInterval);
            timerDiv.classList.add('is-hidden');
            resend.classList.remove('is-hidden');
          }
          remaining--;
        };
        tick();
        countdownInterval = setInterval(tick, 1000);
      }

      /* â”€â”€ Resend OTP â”€â”€ */
      async function resendOTP() {
        try {
          const res = await fetch(`${API_BASE}/auth/request-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: registeredEmail }),
          });
          if (res.ok) {
            startCountdown(600);
            otpInputs.forEach((i) => (i.value = ''));
            document.getElementById('verifyBtn').disabled = true;
          }
        } catch (ex) {
          console.error('Resend failed', ex);
        }
      }

      /* â”€â”€ Verify OTP â”€â”€ */
      async function verifyOTP() {
        const btn = document.getElementById('verifyBtn');
        const err = document.getElementById('step2Error');
        err.style.display = 'none';
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù‚Ù‚...';

        try {
          const res = await fetch(`${API_BASE}/auth/verify-otp`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: registeredEmail,
              code: getOTPValue(),
            }),
          });
          const data = await res.json();

          if (
            res.ok &&
            (data.status === 'success' || data.status === 'already_verified')
          ) {
            if (data.access_token)
              localStorage.setItem('token', data.access_token);
            clearInterval(countdownInterval);
            goToStep(3);
          } else {
            err.textContent = data.detail || data.message || 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­';
            err.style.display = 'block';
            otpInputs.forEach((i) => (i.value = ''));
            otpInputs[0].focus();
          }
        } catch (ex) {
          err.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±';
          err.style.display = 'block';
        }
        btn.disabled = false;
        btn.textContent = 'ØªØ­Ù‚Ù‚ ÙˆÙØ¹Ù‘Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨';
        checkOTPComplete();
      }

      /* â”€â”€ Go to chat â”€â”€ */
      function goToChat() {
        window.location.href = '/chat';
      }
    </script>
  </body>
</html>
