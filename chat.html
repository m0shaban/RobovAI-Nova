<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RobovAI Nova Agent - Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&family=Tajawal:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸŒŒ RobovAI Nova Agent - Ultimate Cosmic Interface
           Design Philosophy: Cyber-Cosmic Egyptian Premium
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      :root {
        --bg-void: #000000;
        --bg-space: #050510;
        --glass: rgba(10, 10, 20, 0.7);
        --glass-light: rgba(255, 255, 255, 0.03);
        --primary: #00f0ff; /* Neon Cyan */
        --secondary: #8b5cf6; /* Purple */
        --accent: #ff00aa; /* Magenta */
        --gold: #ffd700;
        --text: #ffffff;
        --text-muted: #6b7280;
        --border: rgba(255, 255, 255, 0.08);
        --glow-cyan: rgba(0, 240, 255, 0.4);
        --glow-purple: rgba(139, 92, 246, 0.4);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html,
      body {
        font-family: 'Cairo', 'Tajawal', sans-serif;
        background: var(--bg-void);
        color: var(--text);
        height: 100%;
        overflow: hidden;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¬ STARTUP ANIMATION - Cinematic Intro
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      #startupOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--bg-void);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition:
          opacity 1s ease,
          visibility 1s;
      }

      #startupOverlay.hidden {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }

      .startup-logo {
        width: 120px;
        height: 120px;
        border-radius: 30px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        animation:
          pulse-glow 2s ease-in-out infinite,
          float 3s ease-in-out infinite;
        box-shadow:
          0 0 60px var(--glow-cyan),
          0 0 100px var(--glow-purple);
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow:
            0 0 30px var(--glow-cyan),
            0 0 60px var(--glow-purple);
        }
        50% {
          box-shadow:
            0 0 60px var(--glow-cyan),
            0 0 100px var(--glow-purple);
        }
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .startup-title {
        margin-top: 30px;
        font-size: 32px;
        font-weight: 900;
        background: linear-gradient(
          90deg,
          var(--primary),
          var(--secondary),
          var(--accent)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: shimmer 3s linear infinite;
        background-size: 200% auto;
      }

      @keyframes shimmer {
        to {
          background-position: 200% center;
        }
      }

      .startup-subtitle {
        margin-top: 10px;
        font-size: 16px;
        color: var(--text-muted);
        letter-spacing: 3px;
      }

      .startup-loader {
        margin-top: 40px;
        display: flex;
        gap: 8px;
      }

      .loader-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--primary);
        animation: bounce 1.4s infinite ease-in-out both;
      }
      .loader-dot:nth-child(1) {
        animation-delay: -0.32s;
      }
      .loader-dot:nth-child(2) {
        animation-delay: -0.16s;
      }
      .loader-dot:nth-child(3) {
        animation-delay: 0s;
      }

      @keyframes bounce {
        0%,
        80%,
        100% {
          transform: scale(0);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .startup-status {
        margin-top: 20px;
        font-size: 13px;
        color: var(--primary);
        opacity: 0.8;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸŒŒ COSMIC BACKGROUND - Dynamic Effects
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      #cosmicBg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
      }

      .nebula {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        opacity: 0.4;
        animation: drift 20s ease-in-out infinite alternate;
      }

      .nebula-1 {
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, var(--secondary), transparent);
        top: -200px;
        right: -200px;
      }

      .nebula-2 {
        width: 500px;
        height: 500px;
        background: radial-gradient(circle, var(--primary), transparent);
        bottom: -150px;
        left: -150px;
        animation-delay: -10s;
      }

      .nebula-3 {
        width: 400px;
        height: 400px;
        background: radial-gradient(circle, var(--accent), transparent);
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.2;
        animation-delay: -5s;
      }

      @keyframes drift {
        0% {
          transform: translate(0, 0) scale(1);
        }
        100% {
          transform: translate(30px, -30px) scale(1.1);
        }
      }

      .star {
        position: absolute;
        background: white;
        border-radius: 50%;
        animation: twinkle 3s ease-in-out infinite;
      }

      @keyframes twinkle {
        0%,
        100% {
          opacity: 0.3;
          transform: scale(1);
        }
        50% {
          opacity: 1;
          transform: scale(1.5);
        }
      }

      .shooting-star {
        position: absolute;
        width: 100px;
        height: 2px;
        background: linear-gradient(to left, transparent, var(--primary));
        animation: shoot 3s linear infinite;
        opacity: 0;
      }

      @keyframes shoot {
        0% {
          transform: translateX(0) translateY(0);
          opacity: 0;
        }
        5% {
          opacity: 1;
        }
        100% {
          transform: translateX(-500px) translateY(500px);
          opacity: 0;
        }
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“± MAIN LAYOUT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      .app-shell {
        display: flex;
        height: 100%;
        opacity: 0;
        transition: opacity 0.5s ease;
      }

      .app-shell.visible {
        opacity: 1;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ—‚ï¸ SIDEBAR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      .sidebar {
        width: 300px;
        height: 100%;
        background: var(--glass);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        z-index: 50;
      }

      .sidebar.collapsed {
        width: 80px;
      }

      .sidebar-toggle {
        position: absolute;
        left: -18px;
        top: 30px;
        width: 36px;
        height: 36px;
        background: var(--bg-space);
        border: 1px solid var(--border);
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        z-index: 100;
      }

      .sidebar-toggle:hover {
        background: var(--primary);
        color: black;
        transform: scale(1.1);
        box-shadow: 0 0 20px var(--glow-cyan);
      }

      .sidebar-header {
        padding: 25px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .brand-icon {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        box-shadow: 0 0 20px var(--glow-cyan);
      }

      .brand-info {
        overflow: hidden;
        transition:
          opacity 0.3s,
          width 0.3s;
      }

      .sidebar.collapsed .brand-info {
        opacity: 0;
        width: 0;
      }

      .brand-name {
        font-size: 18px;
        font-weight: 800;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .brand-tag {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      /* Tabs */
      .sidebar-tabs {
        display: flex;
        padding: 15px;
        gap: 10px;
      }

      .sidebar.collapsed .sidebar-tabs {
        flex-direction: column;
        padding: 10px;
      }

      .tab-btn {
        flex: 1;
        padding: 10px;
        background: transparent;
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.3s;
        font-family: inherit;
        font-size: 12px;
      }

      .tab-btn.active {
        background: rgba(0, 240, 255, 0.1);
        border-color: var(--primary);
        color: var(--primary);
      }

      .sidebar.collapsed .tab-btn span {
        display: none;
      }

      /* Scrollable Content */
      .sidebar-scroll {
        flex: 1;
        overflow-y: auto;
        padding: 10px 15px;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }

      .sidebar-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .sidebar-scroll::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      .cat-header {
        font-size: 11px;
        color: var(--primary);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 20px 0 10px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .cat-header::before {
        content: '';
        width: 8px;
        height: 8px;
        background: var(--secondary);
        border-radius: 50%;
      }

      .sidebar.collapsed .cat-header {
        display: none;
      }

      .tool-card,
      .history-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-bottom: 6px;
        border: 1px solid transparent;
      }

      .tool-card:hover,
      .history-card:hover {
        background: var(--glass-light);
        border-color: var(--border);
        transform: translateX(-5px);
      }

      .tool-emoji {
        font-size: 20px;
        transition: transform 0.3s;
      }

      .tool-card:hover .tool-emoji {
        transform: scale(1.2);
      }

      .tool-info {
        overflow: hidden;
      }
      .sidebar.collapsed .tool-info {
        display: none;
      }

      .tool-name {
        font-size: 13px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .tool-desc {
        font-size: 10px;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .sidebar.collapsed .tool-card {
        justify-content: center;
        padding: 15px;
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ’¬ MAIN CHAT AREA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      .main-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
      }

      /* Hero State */
      .hero-section {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 100%;
        max-width: 700px;
        padding: 20px;
        transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
      }

      .main-area.chatting .hero-section {
        opacity: 0;
        transform: translate(-50%, -100%);
        pointer-events: none;
      }

      .hero-icon {
        width: 100px;
        height: 100px;
        margin: 0 auto 30px;
        border-radius: 25px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 45px;
        animation: hero-pulse 3s ease-in-out infinite;
        box-shadow: 0 0 50px var(--glow-cyan);
      }

      @keyframes hero-pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .hero-title {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 15px;
      }

      .hero-subtitle {
        font-size: 16px;
        color: var(--text-muted);
        margin-bottom: 40px;
        line-height: 1.8;
      }

      .hero-suggestions {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
      }

      .suggestion-pill {
        padding: 12px 24px;
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .suggestion-pill:hover {
        background: rgba(0, 240, 255, 0.1);
        border-color: var(--primary);
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      /* Chat Area */
      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 100px 20px 150px;
        opacity: 0;
        transition: opacity 0.5s;
      }

      .main-area.chatting .chat-container {
        opacity: 1;
      }

      .message-wrapper {
        max-width: 800px;
        margin: 0 auto 30px;
        display: flex;
        gap: 15px;
        animation: msg-in 0.5s cubic-bezier(0.2, 0.9, 0.3, 1);
      }

      .message-wrapper.user {
        flex-direction: row-reverse;
      }

      @keyframes msg-in {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .msg-avatar {
        width: 45px;
        height: 45px;
        border-radius: 15px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background: var(--glass);
        border: 1px solid var(--border);
      }

      .message-wrapper.bot .msg-avatar {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        box-shadow: 0 0 20px var(--glow-cyan);
      }

      .msg-content {
        max-width: 70%;
        font-size: 16px;
        line-height: 1.8;
      }

      .message-wrapper.user .msg-content {
        background: linear-gradient(
          135deg,
          rgba(139, 92, 246, 0.2),
          rgba(0, 240, 255, 0.1)
        );
        padding: 18px 24px;
        border-radius: 20px;
        border: 1px solid rgba(139, 92, 246, 0.3);
      }

      .msg-content pre {
        background: rgba(0, 0, 0, 0.5);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow-x: auto;
        margin: 15px 0;
        direction: ltr;
        text-align: left;
      }

      .msg-content code {
        color: var(--primary);
        font-family: 'Fira Code', monospace;
      }

      .msg-content img {
        max-width: 100%;
        border-radius: 12px;
        margin: 15px 0;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      /* Input Dock */
      .input-dock {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 750px;
        padding: 0 20px;
        z-index: 20;
      }

      .input-container {
        background: var(--glass);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border: 1px solid var(--border);
        border-radius: 25px;
        padding: 8px;
        display: flex;
        align-items: flex-end;
        gap: 8px;
        transition: all 0.3s;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      }

      .input-container:focus-within {
        border-color: var(--primary);
        box-shadow:
          0 0 40px var(--glow-cyan),
          0 10px 50px rgba(0, 0, 0, 0.5);
      }

      .input-actions {
        display: flex;
        gap: 5px;
      }

      .action-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      }

      .action-btn:hover {
        background: var(--glass-light);
        color: var(--primary);
        transform: scale(1.1);
      }

      .action-btn.recording {
        color: #ff4444;
        animation: pulse-red 1s ease-in-out infinite;
      }

      @keyframes pulse-red {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.5);
        }
        50% {
          box-shadow: 0 0 0 10px rgba(255, 68, 68, 0);
        }
      }

      #messageInput {
        flex: 1;
        background: transparent;
        border: none;
        color: white;
        font-family: inherit;
        font-size: 16px;
        padding: 12px;
        resize: none;
        max-height: 150px;
        min-height: 24px;
        outline: none;
        line-height: 1.5;
      }

      .send-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: black;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: bold;
      }

      .send-btn:hover {
        transform: scale(1.1) rotate(10deg);
        box-shadow: 0 0 30px var(--glow-cyan);
      }

      .input-footer {
        text-align: center;
        margin-top: 12px;
        font-size: 11px;
        color: var(--text-muted);
        opacity: 0.6;
      }

      /* Typing Indicator */
      .typing-indicator {
        display: flex;
        gap: 5px;
        padding: 15px;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: var(--primary);
        border-radius: 50%;
        animation: typing-bounce 1.4s ease-in-out infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing-bounce {
        0%,
        100% {
          transform: translateY(0);
          opacity: 0.5;
        }
        50% {
          transform: translateY(-8px);
          opacity: 1;
        }
      }

      /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“± RESPONSIVE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          right: 0;
          transform: translateX(100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .sidebar-toggle {
          display: none;
        }
        .hero-title {
          font-size: 22px;
        }
        .suggestion-pill {
          font-size: 12px;
          padding: 10px 18px;
        }
      }
    </style>
  </head>
  <body>
    <script>
      // ğŸ”’ Auth Check
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
      }
    </script>

    <!-- ğŸ¬ STARTUP ANIMATION -->
    <div id="startupOverlay">
      <div class="startup-logo">
        <img
          src="public/assets/logo.png"
          alt="Logo"
          style="width: 80%; height: 80%; object-fit: contain"
        />
      </div>
      <div class="startup-title">RobovAI Nova Agent</div>
      <div class="startup-subtitle">INTELLIGENT ASSISTANT</div>
      <div class="startup-loader">
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
        <div class="loader-dot"></div>
      </div>
      <div class="startup-status" id="startupStatus">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
    </div>

    <!-- ğŸŒŒ COSMIC BACKGROUND -->
    <div id="cosmicBg">
      <div class="nebula nebula-1"></div>
      <div class="nebula nebula-2"></div>
      <div class="nebula nebula-3"></div>
      <!-- Stars injected by JS -->
    </div>

    <!-- ğŸ“± MAIN APP -->
    <div class="app-shell" id="appShell">
      <!-- ğŸ—‚ï¸ SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <button class="sidebar-toggle" onclick="toggleSidebar()">â‡„</button>

        <div class="sidebar-header">
          <div class="brand-icon">
            <img
              src="public/assets/logo.png"
              alt="Logo"
              style="width: 80%; height: 80%; object-fit: contain"
            />
          </div>
          <div class="brand-info">
            <div class="brand-name">RobovAI Nova</div>
            <div class="brand-tag">Agent â€¢ 99 Ø£Ø¯Ø§Ø©</div>
          </div>
        </div>

        <!-- New Navigation Section -->
        <div class="sidebar-nav" style="padding: 15px 15px 0">
          <a href="/" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
          </a>
          <button class="nav-item active" onclick="startNewChat()">
            <span class="nav-icon">â•</span>
            <span class="nav-text">Ø´Ø§Øª Ø¬Ø¯ÙŠØ¯</span>
          </button>
          <a href="settings.html" class="nav-item">
            <span class="nav-icon">âš™ï¸</span>
            <span class="nav-text">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
          </a>
        </div>

        <div
          class="sidebar-divider"
          style="height: 1px; background: var(--border); margin: 15px"
        ></div>

        <div class="sidebar-tabs">
          <button class="tab-btn active" onclick="switchTab('tools', this)">
            ğŸ› ï¸ <span>Ø§Ù„Ø£Ø¯ÙˆØ§Øª</span>
          </button>
          <button class="tab-btn" onclick="switchTab('history', this)">
            ğŸ“œ <span>Ø§Ù„Ø³Ø¬Ù„</span>
          </button>
        </div>

        <div style="padding: 0 1.5rem; margin-top: 1rem">
          <button class="btn logout-btn" onclick="logout()">
            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
          </button>
        </div>

        <script>
          async function logout() {
            try {
              await fetch(`${API}/auth/logout`, { method: 'POST' });
            } catch (e) {
              console.error(e);
            }

            localStorage.removeItem('token');
            window.location.href = '/login';
          }

          function startNewChat() {
            // Logic to clear chat and start fresh
            const chatContainer = document.querySelector('.chat-container');
            if (chatContainer) chatContainer.innerHTML = '';
            // Show hero section again if hidden
            const mainArea = document.querySelector('.main-area');
            if (mainArea) mainArea.classList.remove('chatting');
          }
        </script>

        <style>
          .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            width: 100%;
            border-radius: 12px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 5px;
            font-family: inherit;
            font-size: 14px;
          }

          .nav-item:hover,
          .nav-item.active {
            background: rgba(0, 240, 255, 0.1);
            border-color: rgba(0, 240, 255, 0.2);
            color: var(--primary);
          }

          .nav-icon {
            font-size: 18px;
          }

          .sidebar.collapsed .nav-text {
            display: none;
          }
          .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px;
          }

          .logout-btn {
            width: 100%;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
          }
          .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
          }
          .sidebar.collapsed .logout-btn {
            font-size: 0;
            padding: 8px 0;
          }
          .sidebar.collapsed .logout-btn::before {
            content: 'ğŸšª';
            font-size: 16px;
          }
        </style>

        <div class="sidebar-scroll" id="sidebarContent">
          <!-- Populated by JS -->
        </div>
      </aside>

      <!-- ğŸ’¬ MAIN AREA -->
      <main class="main-area" id="mainArea">
        <!-- Hero Section -->
        <div class="hero-section">
          <div class="hero-icon">
            <img
              src="public/assets/logo.png"
              alt="Nova"
              style="width: 60%; height: 60%; object-fit: contain"
            />
          </div>
          <div class="hero-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ RobovAI Nova Agent</div>
          <div class="hero-subtitle">
            Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØµØ±ÙŠ ğŸ‡ªğŸ‡¬ Ù…Ø¹Ø§ÙŠØ§ 99 Ø£Ø¯Ø§Ø© Ù‚ÙˆÙŠØ©!<br />
            Ø§Ø³Ø£Ù„Ù†ÙŠ Ø£ÙŠ Ø­Ø§Ø¬Ø© Ø£Ùˆ Ø¬Ø±Ø¨ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø¯ÙŠ...
          </div>
          <div class="hero-suggestions">
            <div class="suggestion-pill" onclick="quickSend('/weather Cairo')">
              ğŸŒ¦ï¸ Ø§Ù„Ø·Ù‚Ø³ ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
            </div>
            <div
              class="suggestion-pill"
              onclick="quickSend('/generate_image Ù…Ø¯ÙŠÙ†Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©')"
            >
              ğŸ¨ ØªÙˆÙ„ÙŠØ¯ ØµÙˆØ±Ø©
            </div>
            <div class="suggestion-pill" onclick="quickSend('/joke')">
              ğŸ˜‚ Ù†ÙƒØªØ©
            </div>
            <div
              class="suggestion-pill"
              onclick="quickSend('/translate_egy Hello World')"
            >
              ğŸ—£ï¸ ØªØ±Ø¬Ù…Ø© Ù…ØµØ±ÙŠ
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-container" id="chatContainer">
          <!-- Messages injected by JS -->
        </div>

        <!-- Input Dock -->
        <div class="input-dock">
          <div class="input-container">
            <div class="input-actions">
              <button
                class="action-btn"
                onclick="triggerUpload()"
                title="Ø±ÙØ¹ Ù…Ù„Ù"
              >
                ğŸ“‚
              </button>
              <button
                class="action-btn"
                id="voiceBtn"
                onclick="toggleVoice()"
                title="ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ"
              >
                ğŸ™ï¸
              </button>
            </div>
            <textarea
              id="messageInput"
              rows="1"
              placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
              oninput="autoResize(this)"
              onkeydown="
                if (event.key === 'Enter' && !event.shiftKey) {
                  event.preventDefault();
                  sendMessage();
                }
              "
            ></textarea>
            <button class="send-btn" onclick="sendMessage()">âœ</button>
          </div>
          <div class="input-footer">
            RobovAI Solutions Â© 2026 â€¢ Nova Engine v2.4 â€¢ 99 Tool Active
          </div>
        </div>
      </main>
    </div>

    <!-- Hidden File Input -->
    <input
      type="file"
      id="fileInput"
      hidden
      onchange="handleFileUpload(this)"
    />

    <script>
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ› ï¸ CONFIGURATION
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      const isLocal = location.protocol === 'file:';
      const API = isLocal ? 'http://localhost:8000' : location.origin;

      let toolsData = {};
      let chatActive = false;
      let mediaRecorder = null;
      let audioChunks = [];

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸŒŒ COSMIC EFFECTS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function initCosmos() {
        const bg = document.getElementById('cosmicBg');

        // Stars
        for (let i = 0; i < 80; i++) {
          const star = document.createElement('div');
          star.className = 'star';
          star.style.width = Math.random() * 3 + 'px';
          star.style.height = star.style.width;
          star.style.left = Math.random() * 100 + '%';
          star.style.top = Math.random() * 100 + '%';
          star.style.animationDelay = Math.random() * 5 + 's';
          star.style.animationDuration = 2 + Math.random() * 3 + 's';
          bg.appendChild(star);
        }

        // Shooting stars
        for (let i = 0; i < 3; i++) {
          const shooting = document.createElement('div');
          shooting.className = 'shooting-star';
          shooting.style.top = Math.random() * 50 + '%';
          shooting.style.right = Math.random() * 30 + '%';
          shooting.style.animationDelay = i * 5 + Math.random() * 5 + 's';
          bg.appendChild(shooting);
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¬ STARTUP SEQUENCE
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      async function startupSequence() {
        const status = document.getElementById('startupStatus');
        const overlay = document.getElementById('startupOverlay');
        const appShell = document.getElementById('appShell');

        const steps = [
          { text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®ÙˆØ§Ø¯Ù…...', delay: 800 },
          { text: 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©...', delay: 1000 },
          { text: 'ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ùƒ Nova AI...', delay: 800 },
          { text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...', delay: 600 },
        ];

        for (const step of steps) {
          status.textContent = step.text;
          await new Promise((r) => setTimeout(r, step.delay));
        }

        // Load tools
        await loadTools();

        // Fade out overlay
        overlay.classList.add('hidden');
        appShell.classList.add('visible');
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¡ API FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      async function loadTools() {
        try {
          const res = await fetch(`${API}/tools`);
          const data = await res.json();
          if (data.status === 'success') {
            toolsData = data.grouped;
            renderSidebar('tools');
          }
        } catch (e) {
          console.error('Failed to load tools:', e);
          document.getElementById('sidebarContent').innerHTML =
            '<div style="text-align:center;padding:30px;color:#ff4444">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
        }
      }

      function renderSidebar(tab) {
        const container = document.getElementById('sidebarContent');
        container.innerHTML = '';

        if (tab === 'tools') {
          const emojis = [
            'ğŸ”§',
            'âš¡',
            'ğŸ¨',
            'ğŸ“Š',
            'ğŸµ',
            'ğŸŒ',
            'ğŸ“',
            'ğŸ®',
            'ğŸ”¬',
            'ğŸ’¡',
          ];
          let emojiIndex = 0;

          for (const [category, tools] of Object.entries(toolsData)) {
            const header = document.createElement('div');
            header.className = 'cat-header';
            header.textContent = category;
            container.appendChild(header);

            tools.forEach((tool) => {
              const card = document.createElement('div');
              card.className = 'tool-card';
              card.onclick = () => setInput(tool.name + ' ');
              card.innerHTML = `
                            <span class="tool-emoji">${emojis[emojiIndex % emojis.length]}</span>
                            <div class="tool-info">
                                <div class="tool-name">${tool.name}</div>
                                <div class="tool-desc">${tool.description || ''}</div>
                            </div>
                        `;
              container.appendChild(card);
              emojiIndex++;
            });
          }
        } else {
          // Real History from API
          loadConversationHistory(container);
        }
      }

      async function loadConversationHistory(container) {
        container.innerHTML =
          '<div style="text-align:center;padding:30px;color:var(--text-muted)">â³ Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        try {
          const res = await fetch(
            `${API}/history/conversations?user_id=default`,
          );
          const data = await res.json();

          if (data.status === 'success' && data.conversations.length > 0) {
            container.innerHTML = '';

            // Group by date
            const grouped = { Ø§Ù„ÙŠÙˆÙ…: [], Ø£Ù…Ø³: [], 'Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹': [], Ø£Ù‚Ø¯Ù…: [] };
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            const weekAgo = new Date(Date.now() - 7 * 86400000);

            data.conversations.forEach((conv) => {
              const convDate = new Date(conv.updated_at);
              if (convDate.toDateString() === today) {
                grouped['Ø§Ù„ÙŠÙˆÙ…'].push(conv);
              } else if (convDate.toDateString() === yesterday) {
                grouped['Ø£Ù…Ø³'].push(conv);
              } else if (convDate > weekAgo) {
                grouped['Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹'].push(conv);
              } else {
                grouped['Ø£Ù‚Ø¯Ù…'].push(conv);
              }
            });

            for (const [label, convs] of Object.entries(grouped)) {
              if (convs.length === 0) continue;

              const header = document.createElement('div');
              header.className = 'cat-header';
              header.textContent = label;
              container.appendChild(header);

              convs.forEach((conv) => {
                const card = document.createElement('div');
                card.className = 'history-card';
                card.onclick = () => loadConversation(conv.id);
                card.innerHTML = `
                                <span class="tool-emoji">${conv.is_favorite ? 'â­' : 'ğŸ’¬'}</span>
                                <div class="tool-info">
                                    <div class="tool-name">${conv.title}</div>
                                    <div class="tool-desc">${conv.message_count} Ø±Ø³Ø§Ù„Ø©</div>
                                </div>
                            `;
                container.appendChild(card);
              });
            }
          } else {
            container.innerHTML =
              '<div style="text-align:center;padding:30px;color:var(--text-muted)">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
          }
        } catch (e) {
          console.error('Error loading history:', e);
          container.innerHTML =
            '<div style="text-align:center;padding:30px;color:var(--text-muted)">ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>';
        }
      }

      async function loadConversation(convId) {
        try {
          const res = await fetch(
            `${API}/history/conversation/${convId}?user_id=default`,
          );
          const data = await res.json();

          if (data.status === 'success') {
            activateChat();
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';

            data.conversation.messages.forEach((msg) => {
              if (msg.role === 'user') {
                addUserMessage(msg.content);
              } else {
                addBotMessage(msg.content);
              }
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        } catch (e) {
          console.error('Error loading conversation:', e);
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’¬ CHAT FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function activateChat() {
        if (!chatActive) {
          chatActive = true;
          document.getElementById('mainArea').classList.add('chatting');
        }
      }

      function setInput(text) {
        const input = document.getElementById('messageInput');
        input.value = text;
        input.focus();
        autoResize(input);
      }

      function quickSend(text) {
        setInput(text);
        sendMessage();
      }

      function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(el.scrollHeight, 150) + 'px';
      }

      // ğŸ“¨ Fallback API function when streaming fails
      async function sendMessageFallback(text) {
        if (!text.trim()) return;

        activateChat();
        addUserMessage(text);

        const thinkingId = addThinkingIndicator();

        try {
          const response = await fetch(`${API}/agent/run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              message: text,
              user_id: 'web_user',
              platform: 'web',
            }),
          });

          const data = await response.json();
          removeThinkingIndicator(thinkingId);

          if (data.status === 'success') {
            const answer = data.final_answer || data.response || 'ØªÙ…!';
            addBotMessage(formatMarkdown(answer));
          } else {
            addBotMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
          }
        } catch (e) {
          console.error('API error:', e);
          removeThinkingIndicator(thinkingId);
          addBotMessage('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±.');
        }
      }

      function addUserMessage(text) {
        addMessage(text, 'user');
      }

      function addBotMessage(content) {
        addMessage(content, 'bot');
      }

      function addThinkingIndicator() {
        const container = document.getElementById('chatContainer');
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper bot thinking-indicator';
        wrapper.id = 'thinking_' + Date.now();
        wrapper.innerHTML = `
                <div class="msg-avatar">ğŸ¤–</div>
                <div class="msg-content">
                    <div class="thinking-dots">
                        <span>â³</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...
                    </div>
                </div>
            `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        return wrapper.id;
      }

      function removeThinkingIndicator(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      // ğŸ¬ Live Streaming Function
      async function sendMessageWithStreaming(text) {
        if (!text.trim()) return;

        activateChat();
        addMessage(text, 'user');

        // Create EventSource for streaming
        const params = new URLSearchParams({
          message: text,
          user_id: 'web_user',
          platform: 'web',
        });

        const eventSource = new EventSource(`${API}/agent/stream?${params}`);
        const statusId = showAgentStatus('thinking');
        let streamedContent = '';
        let completed = false;

        // Disable default error handler (we use custom one)
        eventSource.onerror = null;

        // Event: Started
        eventSource.addEventListener('started', (e) => {
          console.log('ğŸš€ Stream started');
        });

        // Event: Thinking
        eventSource.addEventListener('thinking', (e) => {
          updateAgentStatus(statusId, 'thinking');
        });

        // Event: Planning
        eventSource.addEventListener('planning', (e) => {
          const data = JSON.parse(e.data);
          updateAgentStatus(statusId, 'planning');

          if (data.plan && data.plan.length > 0) {
            streamedContent += `
                        <div style="background: rgba(139, 92, 246, 0.1); border-left: 3px solid #8b5cf6; padding: 12px; margin: 8px 0; border-radius: 8px;">
                            <div style="font-weight: 600; color: #8b5cf6; margin-bottom: 8px;">ğŸ“‹ Ø§Ù„Ø®Ø·Ø©:</div>
                            <ol style="margin: 0; padding-left: 20px;">
                                ${data.plan.map((step) => `<li style="margin: 4px 0;">${step}</li>`).join('')}
                            </ol>
                        </div>
                    `;
          }
        });

        // Event: Executing
        eventSource.addEventListener('executing', (e) => {
          const data = JSON.parse(e.data);
          updateAgentStatus(statusId, 'acting');

          streamedContent += `
                    <div style="background: rgba(255, 0, 170, 0.1); border-left: 3px solid #ff00aa; padding: 10px; margin: 6px 0; border-radius: 8px;">
                        <span style="color: #ff00aa; font-weight: 600;">âš¡ Ø§Ù„Ø®Ø·ÙˆØ© ${data.index}/${data.total}:</span> ${data.step}
                    </div>
                `;
        });

        // Event: Observing
        eventSource.addEventListener('observing', (e) => {
          updateAgentStatus(statusId, 'observing');
        });

        // Event: Reflecting
        eventSource.addEventListener('reflecting', (e) => {
          updateAgentStatus(statusId, 'reflecting');
        });

        // Event: Completed
        eventSource.addEventListener('completed', (e) => {
          completed = true;
          const data = JSON.parse(e.data);
          hideAgentStatus(statusId);

          streamedContent += `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                        ${formatMarkdown(data.final_answer)}
                    </div>
                `;

          addMessage(streamedContent, 'bot');
          eventSource.close();
        });

        // Event: Done (stream finished)
        eventSource.addEventListener('done', (e) => {
          console.log('âœ… Stream done');
          if (!completed) {
            hideAgentStatus(statusId);
            if (streamedContent) {
              addMessage(streamedContent, 'bot');
            }
          }
          eventSource.close();
        });

        // Event: Error
        eventSource.addEventListener('error', (e) => {
          // Ignore errors if already completed
          if (completed) {
            eventSource.close();
            return;
          }

          console.error('âŒ Stream error:', e);
          hideAgentStatus(statusId);

          if (streamedContent) {
            addMessage(
              streamedContent + '<br><br>âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°',
              'bot',
            );
          } else {
            addMessage('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'bot');
          }

          eventSource.close();
        });

        // Timeout fallback (extended to 5 minutes for long tasks)
        setTimeout(() => {
          if (eventSource.readyState !== EventSource.CLOSED) {
            eventSource.close();
            if (!streamedContent) {
              hideAgentStatus(statusId);
              addMessage(
                'â±ï¸ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØºØ±Ù‚Øª ÙˆÙ‚ØªØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹)',
                'bot',
              );
            }
          }
        }, 300000);
      }

      async function sendMessage() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        input.style.height = 'auto';

        // Try streaming first, fallback to regular API
        try {
          await sendMessageWithStreaming(text);
        } catch (e) {
          console.error('Streaming failed, using fallback:', e);
          await sendMessageFallback(text);
        }
      }

      function addMessage(content, role) {
        const container = document.getElementById('chatContainer');
        const wrapper = document.createElement('div');
        wrapper.className = `message-wrapper ${role}`;

        const avatar = role === 'bot' ? 'ğŸ¤–' : 'ğŸ‘¤';

        wrapper.innerHTML = `
                <div class="msg-avatar">${avatar}</div>
                <div class="msg-content">${content}</div>
            `;

        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
      }

      function showTyping() {
        const id = 'typing-' + Date.now();
        const container = document.getElementById('chatContainer');
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper bot';
        wrapper.id = id;
        wrapper.innerHTML = `
                <div class="msg-avatar">ğŸ¤–</div>
                <div class="msg-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        return id;
      }

      function hideTyping(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      // ğŸš€ Agent Status Functions - Show thinking phases
      function showAgentStatus(phase = 'thinking') {
        const id = 'agent-status-' + Date.now();
        const container = document.getElementById('chatContainer');
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper bot';
        wrapper.id = id;

        const statusConfig = {
          thinking: {
            icon: 'ğŸ§ ',
            text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„ Ø·Ù„Ø¨Ùƒ...',
            color: '#00f0ff',
          },
          planning: {
            icon: 'ğŸ“‹',
            text: 'Ø¬Ø§Ø±ÙŠ ÙˆØ¶Ø¹ Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„...',
            color: '#8b5cf6',
          },
          acting: { icon: 'âš¡', text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...', color: '#ff00aa' },
          observing: {
            icon: 'ğŸ”',
            text: 'Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...',
            color: '#ffd700',
          },
          reflecting: {
            icon: 'ğŸ’­',
            text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©...',
            color: '#00ff88',
          },
        };

        const config = statusConfig[phase] || statusConfig.thinking;

        wrapper.innerHTML = `
                <div class="msg-avatar">ğŸ¤–</div>
                <div class="msg-content">
                    <div style="display: flex; align-items: center; gap: 12px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; border: 1px solid ${config.color}33;">
                        <div style="font-size: 24px; animation: pulse 1.5s ease-in-out infinite;">${config.icon}</div>
                        <div>
                            <div style="font-weight: 600; color: ${config.color}; margin-bottom: 4px;">Nova Agent</div>
                            <div class="agent-status-text" style="color: #aaa; font-size: 14px;">${config.text}</div>
                        </div>
                        <div class="typing-indicator" style="margin-right: auto;">
                            <div class="typing-dot" style="background: ${config.color};"></div>
                            <div class="typing-dot" style="background: ${config.color};"></div>
                            <div class="typing-dot" style="background: ${config.color};"></div>
                        </div>
                    </div>
                </div>
            `;

        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
        return id;
      }

      function updateAgentStatus(id, phase) {
        const el = document.getElementById(id);
        if (!el) return;

        const statusConfig = {
          thinking: {
            icon: 'ğŸ§ ',
            text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„ Ø·Ù„Ø¨Ùƒ...',
            color: '#00f0ff',
          },
          planning: {
            icon: 'ğŸ“‹',
            text: 'Ø¬Ø§Ø±ÙŠ ÙˆØ¶Ø¹ Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„...',
            color: '#8b5cf6',
          },
          acting: { icon: 'âš¡', text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...', color: '#ff00aa' },
          observing: {
            icon: 'ğŸ”',
            text: 'Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...',
            color: '#ffd700',
          },
          reflecting: {
            icon: 'ğŸ’­',
            text: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø©...',
            color: '#00ff88',
          },
        };

        const config = statusConfig[phase] || statusConfig.thinking;
        const textEl = el.querySelector('.agent-status-text');
        if (textEl) {
          textEl.textContent = config.text;
          textEl.style.color = config.color;
        }
      }

      function hideAgentStatus(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
      }

      function formatMarkdown(text) {
        return text
          .replace(/\n/g, '<br>')
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
          .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">');
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ¤ VOICE & FILES
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function triggerUpload() {
        document.getElementById('fileInput').click();
      }

      async function handleFileUpload(input) {
        if (!input.files.length) return;

        activateChat();
        const file = input.files[0];
        const isImage = file.type.startsWith('image/');

        addMessage(`ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹: ${file.name}...`, 'user');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('user_id', 'web_user');

        const headers = {
          Authorization: `Bearer ${localStorage.getItem('token')}`,
        };

        try {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… endpoint Ù…Ø®ØªÙ„Ù Ù„Ù„ØµÙˆØ±
          const endpoint = isImage ? '/upload_image' : '/upload';
          const res = await fetch(`${API}${endpoint}`, {
            method: 'POST',
            headers: headers,
            body: formData,
          });
          const data = await res.json();

          if (data.status === 'success') {
            if (isImage && data.response) {
              // Ø§Ù„ØµÙˆØ±Ø© ØªÙ… Ø±ÙØ¹Ù‡Ø§ Ø¹Ù„Ù‰ ImgBB - Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
              addMessage(formatMarkdown(data.response), 'bot');
            } else {
              // Ù…Ù„Ù Ø¹Ø§Ø¯ÙŠ - Ø§Ø³Ø£Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§Ø°Ø§ ÙŠØ±ÙŠØ¯
              const loadingId = showTyping();
              const res2 = await fetch(`${API}/webhook`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
                body: JSON.stringify({
                  user_id: 'web_user',
                  message: `ØªÙ… Ø±ÙØ¹ Ù…Ù„Ù: ${file.name}`,
                  platform: 'web',
                }),
              });
              const data2 = await res2.json();
              hideTyping(loadingId);
              addMessage(
                formatMarkdown(
                  data2.response || data2.output || 'ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…',
                ),
                'bot',
              );
            }
          } else {
            addMessage(`âŒ ${data.message || 'ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù'}`, 'bot');
          }
        } catch (e) {
          addMessage('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ' + e.message, 'bot');
        }
      }

      async function toggleVoice() {
        const btn = document.getElementById('voiceBtn');

        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
              const blob = new Blob(audioChunks, { type: 'audio/webm' });
              sendAudio(blob);
            };

            mediaRecorder.start();
            btn.classList.add('recording');
            btn.textContent = 'â¹ï¸';
          } catch (e) {
            alert('ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†');
          }
        } else {
          mediaRecorder.stop();
          btn.classList.remove('recording');
          btn.textContent = 'ğŸ™ï¸';
        }
      }

      async function sendAudio(blob) {
        activateChat();

        // Show typing indicator while processing
        const loadingId = showTyping();

        const formData = new FormData();
        formData.append('audio', blob, 'recording.webm');
        formData.append('user_id', 'web_user');
        formData.append('platform', 'web');

        try {
          const res = await fetch(`${API}/webhook_audio`, {
            method: 'POST',
            body: formData,
          });
          const data = await res.json();
          hideTyping(loadingId);

          const output = data.response || data.output || 'ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª';

          // Parse the response to extract transcribed text
          // Format from backend: "ğŸ¤ **ØªØ­ÙˆÙŠÙ„ Ù†Ø§Ø¬Ø­!**\n\nğŸ“ **Ø§Ù„Ù†Øµ:** {text}\n\nğŸ’¬ **Ø§Ù„Ø±Ø¯:** {reply}"
          const textMatch = output.match(/ğŸ“\s*\*?\*?Ø§Ù„Ù†Øµ\*?\*?:\s*([^\n]+)/);
          const replyMatch = output.match(
            /ğŸ’¬\s*\*?\*?Ø§Ù„Ø±Ø¯\*?\*?:\s*([\s\S]*?)$/,
          );

          if (textMatch && textMatch[1]) {
            // Show user's spoken text as their message
            addMessage(`ğŸ¤ ${textMatch[1].trim()}`, 'user');

            // Show bot's reply
            if (replyMatch && replyMatch[1]) {
              addMessage(formatMarkdown(replyMatch[1].trim()), 'bot');
            } else {
              addMessage(formatMarkdown(output), 'bot');
            }
          } else {
            // Fallback: show full response
            addMessage(formatMarkdown(output), 'bot');
          }
        } catch (e) {
          hideTyping(loadingId);
          addMessage('âŒ ÙØ´Ù„ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØª: ' + e.message, 'bot');
        }
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ›ï¸ UI CONTROLS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
      }

      function switchTab(tab, btn) {
        document
          .querySelectorAll('.tab-btn')
          .forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        renderSidebar(tab);
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸš€ INIT
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      initCosmos();
      startupSequence();
    </script>
  </body>
</html>
